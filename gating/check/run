#!/bin/bash

## Shell Opts ----------------------------------------------------------------

set -eux
set -o pipefail

## Display environment
echo "+-------------------- ENV VARS --------------------+"
env
echo "+-------------------- ENV VARS --------------------+"

## Vars ----------------------------------------------------------------------

export DEPLOY_AIO="true"
export MNAIO_VAR_FILE="${MNAIO_VAR_FILE:-/tmp/mnaio_vars}"

source "$(readlink -f $(dirname ${0}))/../gating_vars.sh"

## Main ----------------------------------------------------------------------

if [[ $RE_JOB_ACTION == "tox-test" ]]; then
  bash -c "$(readlink -f $(dirname ${0})/run_tox.sh)"
elif [[ $RE_JOB_IMAGE =~ .*mnaio.* ]]; then
  bash -c "$(readlink -f $(dirname ${0})/run_deploy_mnaio.sh)"
  source "${MNAIO_VAR_FILE}"
  if [[ $RE_JOB_ACTION == "deploy" ]]; then
    # run tempest tests on MNAIO for deploy action
    ${MNAIO_SSH} <<EOS
      cd /opt/openstack-ansible
      openstack-ansible -e tempest_run=yes playbooks/os-tempest-install.yml
EOS
  fi
else
  bash -c "$(readlink -f $(dirname ${0})/run_deploy.sh)"
fi
if [[ $RE_JOB_ACTION == "system" ]]; then
  bash -c "$(readlink -f $(dirname ${0})/run_system_tests.sh)"
fi
